---
name: Erlang

"on":
  push:
    branches:
      - main
  pull_request:
    branches:
      - "*"
  workflow_dispatch: {}
  merge_group:

concurrency:
  group: ${{github.workflow}}-${{github.ref}}
  cancel-in-progress: true

jobs:
  cache:
    name: Cache

    runs-on: ubuntu-24.04

    outputs:
      build-cache-key: ${{ steps.set-build-key.outputs.key }}
      rebar-cache-key: ${{ steps.set-rebar-key.outputs.key }}

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - uses: erlef/setup-beam@5304e04ea2b355f03681464e683d92e3b2f18451 # v1.18.2
        id: setup-beam
        with:
          version-type: strict
          version-file: .tool-versions

      - name: Set build cache key
        id: set-build-key
        run: |
          echo "key=\
          _build-\
          ${{ runner.os }}-\
          otp-${{ steps.setup-beam.outputs.otp-version }}-\
          rebar3-hash-${{ hashFiles('rebar.lock') }}" \
          >> "${GITHUB_OUTPUT}"

      - name: Set rebar cache key
        id: set-rebar-key
        run: |
          echo "key=\
          rebar3-\
          ${{ runner.os }}-\
          otp-${{ steps.setup-beam.outputs.otp-version }}-\
          rebar3-${{ steps.setup-beam.outputs.rebar3-version }}" \
          >> "${GITHUB_OUTPUT}"

      - name: Cache _build
        uses: actions/cache@0c907a75c2c80ebcb7f088228285e798b750cf8f # v4.2.1
        with:
          path: _build
          key: ${{ steps.set-build-key.outputs.key }}
          restore-keys: |
            _build-${{ runner.os }}-otp-${{ steps.setup-beam.outputs.otp-version }}-
            _build-${{ runner.os }}-

      - name: Cache rebar3
        uses: actions/cache@0c907a75c2c80ebcb7f088228285e798b750cf8f # v4.2.1
        with:
          path: ~/.cache/rebar3
          key: ${{ steps.set-rebar-key.outputs.key }}
          restore-keys: |
            rebar3-${{ runner.os }}-otp-${{ steps.setup-beam.outputs.otp-version }}-
            rebar3-${{ runner.os }}-

      - name: Compile
        run: |
          rebar3 as test compile

  check:
    name: Check

    needs: cache

    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - uses: erlef/setup-beam@5304e04ea2b355f03681464e683d92e3b2f18451 # v1.18.2
        id: setup-beam
        with:
          version-type: strict
          version-file: .tool-versions

      - name: Restore _build cache
        id: restore-build-cache
        uses: actions/cache@0c907a75c2c80ebcb7f088228285e798b750cf8f # v4.2.1
        with:
          path: _build
          key: ${{ needs.cache.outputs.build-cache-key }}
          restore-keys: |
            _build-${{ runner.os }}-otp-${{ steps.setup-beam.outputs.otp-version }}-
            _build-${{ runner.os }}-

      - name: Restore rebar3 cache
        id: restore-rebar3-cache
        uses: actions/cache@0c907a75c2c80ebcb7f088228285e798b750cf8f # v4.2.1
        with:
          path: ~/.cache/rebar3
          key: ${{ needs.cache.outputs.rebar-cache-key }}
          restore-keys: |
            rebar3-${{ runner.os }}-otp-${{ steps.setup-beam.outputs.otp-version }}-
            rebar3-${{ runner.os }}-

      - name: Check code
        run: |
          rebar3 as test check

  test:
    name: Test

    needs: cache

    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - uses: erlef/setup-beam@5304e04ea2b355f03681464e683d92e3b2f18451 # v1.18.2
        id: setup-beam
        with:
          version-type: strict
          version-file: .tool-versions

      - name: Restore _build cache
        id: restore-build-cache
        uses: actions/cache@0c907a75c2c80ebcb7f088228285e798b750cf8f # v4.2.1
        with:
          path: _build
          key: ${{ needs.cache.outputs.build-cache-key }}
          restore-keys: |
            _build-${{ runner.os }}-otp-${{ steps.setup-beam.outputs.otp-version }}-
            _build-${{ runner.os }}-

      - name: Restore rebar3 cache
        id: restore-rebar3-cache
        uses: actions/cache@0c907a75c2c80ebcb7f088228285e798b750cf8f # v4.2.1
        with:
          path: ~/.cache/rebar3
          key: ${{ needs.cache.outputs.rebar-cache-key }}
          restore-keys: |
            rebar3-${{ runner.os }}-otp-${{ steps.setup-beam.outputs.otp-version }}-
            rebar3-${{ runner.os }}-

      - name: Test
        run: |
          rebar3 as test test

  artifacts:
    name: Verify artifacts

    needs: cache

    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - uses: erlef/setup-beam@5304e04ea2b355f03681464e683d92e3b2f18451 # v1.18.2
        id: setup-beam
        with:
          version-type: strict
          version-file: .tool-versions

      - name: Restore _build cache
        id: restore-build-cache
        uses: actions/cache@0c907a75c2c80ebcb7f088228285e798b750cf8f # v4.2.1
        with:
          path: _build
          key: ${{ needs.cache.outputs.build-cache-key }}
          restore-keys: |
            _build-${{ runner.os }}-otp-${{ steps.setup-beam.outputs.otp-version }}-
            _build-${{ runner.os }}-

      - name: Restore rebar3 cache
        id: restore-rebar3-cache
        uses: actions/cache@0c907a75c2c80ebcb7f088228285e798b750cf8f # v4.2.1
        with:
          path: ~/.cache/rebar3
          key: ${{ needs.cache.outputs.rebar-cache-key }}
          restore-keys: |
            rebar3-${{ runner.os }}-otp-${{ steps.setup-beam.outputs.otp-version }}-
            rebar3-${{ runner.os }}-

      - name: Check if build left artifacts
        run: |
          rebar3 unlock --all
          rebar3 upgrade --all
          git diff --exit-code

  e2e:
    name: E2E Tests

    needs: cache

    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - uses: erlef/setup-beam@5304e04ea2b355f03681464e683d92e3b2f18451 # v1.18.2
        id: setup-beam
        with:
          version-type: strict
          version-file: .tool-versions

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: "20"
          cache: "npm"

      - name: Restore _build cache
        id: restore-build-cache
        uses: actions/cache@0c907a75c2c80ebcb7f088228285e798b750cf8f # v4.2.1
        with:
          path: _build
          key: ${{ needs.cache.outputs.build-cache-key }}
          restore-keys: |
            _build-${{ runner.os }}-otp-${{ steps.setup-beam.outputs.otp-version }}-
            _build-${{ runner.os }}-

      - name: Restore rebar3 cache
        id: restore-rebar3-cache
        uses: actions/cache@0c907a75c2c80ebcb7f088228285e798b750cf8f # v4.2.1
        with:
          path: ~/.cache/rebar3
          key: ${{ needs.cache.outputs.rebar-cache-key }}
          restore-keys: |
            rebar3-${{ runner.os }}-otp-${{ steps.setup-beam.outputs.otp-version }}-
            rebar3-${{ runner.os }}-

      - name: Install Node.js dependencies
        run: npm ci

      - name: Build JavaScript assets
        run: npm run build

      - name: Run JavaScript unit tests
        run: npm run test:unit

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium firefox

      - name: Compile Arizona for test
        run: rebar3 as test compile

      - name: Run E2E tests
        run: npm run test:e2e

      - name: Upload Playwright report
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        if: failure()
        with:
          name: playwright-report
          path: test-results/
          retention-days: 7
