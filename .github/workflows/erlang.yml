---
name: Erlang

"on":
  push:
    branches:
      - main
  pull_request:
    branches:
      - "*"
  workflow_dispatch: {}
  merge_group:

concurrency:
  group: ${{github.workflow}}-${{github.ref}}
  cancel-in-progress: true

jobs:
  cache:
    name: Cache

    runs-on: ubuntu-24.04

    outputs:
      build-cache-key: ${{ steps.set-build-key.outputs.key }}
      rebar-cache-key: ${{ steps.set-rebar-key.outputs.key }}

    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - uses: erlef/setup-beam@e6d7c94229049569db56a7ad5a540c051a010af9 # v1.20.4
        id: setup-beam
        with:
          version-type: strict
          version-file: .tool-versions

      - name: Set build cache key
        id: set-build-key
        run: |
          echo "key=\
          _build-\
          ${{ runner.os }}-\
          otp-${{ steps.setup-beam.outputs.otp-version }}-\
          rebar3-hash-${{ hashFiles('rebar.lock') }}" \
          >> "${GITHUB_OUTPUT}"

      - name: Set rebar cache key
        id: set-rebar-key
        run: |
          echo "key=\
          rebar3-\
          ${{ runner.os }}-\
          otp-${{ steps.setup-beam.outputs.otp-version }}-\
          rebar3-${{ steps.setup-beam.outputs.rebar3-version }}" \
          >> "${GITHUB_OUTPUT}"

      - name: Cache _build
        uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809 # v4.2.4
        with:
          path: _build
          key: ${{ steps.set-build-key.outputs.key }}
          restore-keys: |
            _build-${{ runner.os }}-otp-${{ steps.setup-beam.outputs.otp-version }}-
            _build-${{ runner.os }}-

      - name: Cache rebar3
        uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809 # v4.2.4
        with:
          path: ~/.cache/rebar3
          key: ${{ steps.set-rebar-key.outputs.key }}
          restore-keys: |
            rebar3-${{ runner.os }}-otp-${{ steps.setup-beam.outputs.otp-version }}-
            rebar3-${{ runner.os }}-

      - name: Compile
        run: |
          rebar3 as test compile

  check:
    name: Check

    needs: cache

    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - uses: erlef/setup-beam@e6d7c94229049569db56a7ad5a540c051a010af9 # v1.20.4
        id: setup-beam
        with:
          version-type: strict
          version-file: .tool-versions

      - name: Restore _build cache
        id: restore-build-cache
        uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809 # v4.2.4
        with:
          path: _build
          key: ${{ needs.cache.outputs.build-cache-key }}
          restore-keys: |
            _build-${{ runner.os }}-otp-${{ steps.setup-beam.outputs.otp-version }}-
            _build-${{ runner.os }}-

      - name: Restore rebar3 cache
        id: restore-rebar3-cache
        uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809 # v4.2.4
        with:
          path: ~/.cache/rebar3
          key: ${{ needs.cache.outputs.rebar-cache-key }}
          restore-keys: |
            rebar3-${{ runner.os }}-otp-${{ steps.setup-beam.outputs.otp-version }}-
            rebar3-${{ runner.os }}-

      - name: Check code
        run: |
          rebar3 as test check

  test:
    name: Test

    needs: cache

    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - uses: erlef/setup-beam@e6d7c94229049569db56a7ad5a540c051a010af9 # v1.20.4
        id: setup-beam
        with:
          version-type: strict
          version-file: .tool-versions

      - name: Restore _build cache
        id: restore-build-cache
        uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809 # v4.2.4
        with:
          path: _build
          key: ${{ needs.cache.outputs.build-cache-key }}
          restore-keys: |
            _build-${{ runner.os }}-otp-${{ steps.setup-beam.outputs.otp-version }}-
            _build-${{ runner.os }}-

      - name: Restore rebar3 cache
        id: restore-rebar3-cache
        uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809 # v4.2.4
        with:
          path: ~/.cache/rebar3
          key: ${{ needs.cache.outputs.rebar-cache-key }}
          restore-keys: |
            rebar3-${{ runner.os }}-otp-${{ steps.setup-beam.outputs.otp-version }}-
            rebar3-${{ runner.os }}-

      - name: Test
        run: |
          rebar3 as test test

  artifacts:
    name: Verify artifacts

    needs: cache

    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - uses: erlef/setup-beam@e6d7c94229049569db56a7ad5a540c051a010af9 # v1.20.4
        id: setup-beam
        with:
          version-type: strict
          version-file: .tool-versions

      - name: Restore _build cache
        id: restore-build-cache
        uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809 # v4.2.4
        with:
          path: _build
          key: ${{ needs.cache.outputs.build-cache-key }}
          restore-keys: |
            _build-${{ runner.os }}-otp-${{ steps.setup-beam.outputs.otp-version }}-
            _build-${{ runner.os }}-

      - name: Restore rebar3 cache
        id: restore-rebar3-cache
        uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809 # v4.2.4
        with:
          path: ~/.cache/rebar3
          key: ${{ needs.cache.outputs.rebar-cache-key }}
          restore-keys: |
            rebar3-${{ runner.os }}-otp-${{ steps.setup-beam.outputs.otp-version }}-
            rebar3-${{ runner.os }}-

      - name: Check if build left artifacts
        run: |
          rebar3 unlock --all
          rebar3 upgrade --all
          git diff --exit-code

  e2e:
    name: E2E Tests

    needs: cache

    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - uses: erlef/setup-beam@e6d7c94229049569db56a7ad5a540c051a010af9 # v1.20.4
        id: setup-beam
        with:
          version-type: strict
          version-file: .tool-versions

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version-file: .tool-versions
          cache: "npm"
          cache-dependency-path: "package-lock.json"

      - name: Restore _build cache
        id: restore-build-cache
        uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809 # v4.2.4
        with:
          path: _build
          key: ${{ needs.cache.outputs.build-cache-key }}
          restore-keys: |
            _build-${{ runner.os }}-otp-${{ steps.setup-beam.outputs.otp-version }}-
            _build-${{ runner.os }}-

      - name: Restore rebar3 cache
        id: restore-rebar3-cache
        uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809 # v4.2.4
        with:
          path: ~/.cache/rebar3
          key: ${{ needs.cache.outputs.rebar-cache-key }}
          restore-keys: |
            rebar3-${{ runner.os }}-otp-${{ steps.setup-beam.outputs.otp-version }}-
            rebar3-${{ runner.os }}-

      - name: Install Node.js dependencies
        run: npm ci

      - name: Build JavaScript assets
        run: npm run build

      - name: Run JavaScript unit tests
        run: npm run test:unit

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium firefox

      - name: Compile Arizona for test
        run: rebar3 as test compile

      - name: Run E2E tests
        run: npm run test:e2e

      - name: Upload Playwright report
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: failure()
        with:
          name: playwright-report
          path: test-results/
          retention-days: 7
