---
name: Erlang

"on":
  push:
    branches:
      - main
  pull_request:
    branches:
      - "*"
  workflow_dispatch: {}
  merge_group:

concurrency:
  group: ${{github.workflow}}-${{github.ref}}
  cancel-in-progress: true

jobs:
  cache:
    name: Cache

    runs-on: ubuntu-24.04

    outputs:
      build-cache-key: ${{ steps.set-build-key.outputs.key }}
      rebar-cache-key: ${{ steps.set-rebar-key.outputs.key }}
      playwright-cache-key: ${{ steps.set-playwright-key.outputs.key }}

    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - uses: erlef/setup-beam@e6d7c94229049569db56a7ad5a540c051a010af9 # v1.20.4
        id: setup-beam
        with:
          version-type: strict
          version-file: .tool-versions

      - name: Set build cache key
        id: set-build-key
        run: |
          echo "key=\
          _build-\
          ${{ runner.os }}-\
          otp-${{ steps.setup-beam.outputs.otp-version }}-\
          rebar3-hash-${{ hashFiles('rebar.lock') }}" \
          >> "${GITHUB_OUTPUT}"

      - name: Set rebar cache key
        id: set-rebar-key
        run: |
          echo "key=\
          rebar3-\
          ${{ runner.os }}-\
          otp-${{ steps.setup-beam.outputs.otp-version }}-\
          rebar3-${{ steps.setup-beam.outputs.rebar3-version }}-\
          config-${{ hashFiles('rebar.config') }}" \
          >> "${GITHUB_OUTPUT}"

      - name: Set Playwright cache key
        id: set-playwright-key
        run: |
          echo "key=\
          playwright-\
          ${{ runner.os }}-\
          playwright-${{ hashFiles('package-lock.json') }}" \
          >> "${GITHUB_OUTPUT}"

      - name: Cache _build
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: _build
          key: ${{ steps.set-build-key.outputs.key }}
          restore-keys: |
            _build-${{ runner.os }}-otp-${{ steps.setup-beam.outputs.otp-version }}-
            _build-${{ runner.os }}-

      - name: Cache rebar3
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: ~/.cache/rebar3
          key: ${{ steps.set-rebar-key.outputs.key }}
          restore-keys: |
            rebar3-${{ runner.os }}-otp-${{ steps.setup-beam.outputs.otp-version }}-
            rebar3-${{ runner.os }}-

      - name: Cache Playwright browsers
        id: cache-playwright
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: ~/.cache/ms-playwright
          key: ${{ steps.set-playwright-key.outputs.key }}
          restore-keys: |
            playwright-${{ runner.os }}-

      - name: Setup Node.js
        uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444 # v5.0.0
        with:
          node-version-file: .tool-versions
          cache: "npm"
          cache-dependency-path: "package-lock.json"

      - name: Install Node.js dependencies
        run: npm ci

      - name: Install Playwright browsers
        if: steps.cache-playwright.outputs.cache-hit != 'true'
        run: npx playwright install --with-deps chromium firefox

      - name: Compile
        run: |
          rebar3 as test compile

  check:
    name: Check

    needs: cache

    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - uses: erlef/setup-beam@e6d7c94229049569db56a7ad5a540c051a010af9 # v1.20.4
        id: setup-beam
        with:
          version-type: strict
          version-file: .tool-versions

      - name: Restore _build cache
        id: restore-build-cache
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: _build
          key: ${{ needs.cache.outputs.build-cache-key }}
          restore-keys: |
            _build-${{ runner.os }}-otp-${{ steps.setup-beam.outputs.otp-version }}-
            _build-${{ runner.os }}-

      - name: Restore rebar3 cache
        id: restore-rebar3-cache
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: ~/.cache/rebar3
          key: ${{ needs.cache.outputs.rebar-cache-key }}
          restore-keys: |
            rebar3-${{ runner.os }}-otp-${{ steps.setup-beam.outputs.otp-version }}-
            rebar3-${{ runner.os }}-

      - name: Check code
        run: |
          rebar3 as test check

  test:
    name: Test

    needs: cache

    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - uses: erlef/setup-beam@e6d7c94229049569db56a7ad5a540c051a010af9 # v1.20.4
        id: setup-beam
        with:
          version-type: strict
          version-file: .tool-versions

      - name: Restore _build cache
        id: restore-build-cache
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: _build
          key: ${{ needs.cache.outputs.build-cache-key }}
          restore-keys: |
            _build-${{ runner.os }}-otp-${{ steps.setup-beam.outputs.otp-version }}-
            _build-${{ runner.os }}-

      - name: Restore rebar3 cache
        id: restore-rebar3-cache
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: ~/.cache/rebar3
          key: ${{ needs.cache.outputs.rebar-cache-key }}
          restore-keys: |
            rebar3-${{ runner.os }}-otp-${{ steps.setup-beam.outputs.otp-version }}-
            rebar3-${{ runner.os }}-

      - name: Install inotify tools
        uses: awalsh128/cache-apt-pkgs-action@2c09a5e66da6c8016428a2172bd76e5e4f14bb17 # v1.5.3
        with:
          packages: inotify-tools
          version: 1.0

      - name: Test
        run: |
          rebar3 as test test

  artifacts:
    name: Verify artifacts

    needs: cache

    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - uses: erlef/setup-beam@e6d7c94229049569db56a7ad5a540c051a010af9 # v1.20.4
        id: setup-beam
        with:
          version-type: strict
          version-file: .tool-versions

      - name: Restore _build cache
        id: restore-build-cache
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: _build
          key: ${{ needs.cache.outputs.build-cache-key }}
          restore-keys: |
            _build-${{ runner.os }}-otp-${{ steps.setup-beam.outputs.otp-version }}-
            _build-${{ runner.os }}-

      - name: Restore rebar3 cache
        id: restore-rebar3-cache
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: ~/.cache/rebar3
          key: ${{ needs.cache.outputs.rebar-cache-key }}
          restore-keys: |
            rebar3-${{ runner.os }}-otp-${{ steps.setup-beam.outputs.otp-version }}-
            rebar3-${{ runner.os }}-

      - name: Check if build left artifacts
        run: |
          rebar3 unlock --all
          rebar3 upgrade --all
          git diff --exit-code

  e2e-parallel:
    name: E2E Tests (Parallel)

    needs: cache

    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - uses: erlef/setup-beam@e6d7c94229049569db56a7ad5a540c051a010af9 # v1.20.4
        id: setup-beam
        with:
          version-type: strict
          version-file: .tool-versions

      - name: Setup Node.js
        uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444 # v5.0.0
        with:
          node-version-file: .tool-versions
          cache: "npm"
          cache-dependency-path: "package-lock.json"

      - name: Restore _build cache
        id: restore-build-cache
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: _build
          key: ${{ needs.cache.outputs.build-cache-key }}
          restore-keys: |
            _build-${{ runner.os }}-otp-${{ steps.setup-beam.outputs.otp-version }}-
            _build-${{ runner.os }}-

      - name: Restore rebar3 cache
        id: restore-rebar3-cache
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: ~/.cache/rebar3
          key: ${{ needs.cache.outputs.rebar-cache-key }}
          restore-keys: |
            rebar3-${{ runner.os }}-otp-${{ steps.setup-beam.outputs.otp-version }}-
            rebar3-${{ runner.os }}-

      - name: Restore Playwright browsers cache
        id: restore-playwright-cache
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: ~/.cache/ms-playwright
          key: ${{ needs.cache.outputs.playwright-cache-key }}
          restore-keys: |
            playwright-${{ runner.os }}-

      - name: Install Node.js dependencies
        run: npm ci

      - name: Install Playwright system dependencies
        if: steps.restore-playwright-cache.outputs.cache-hit == 'true'
        run: npx playwright install-deps chromium firefox

      - name: Compile Arizona for test
        run: rebar3 as test compile

      - name: Run parallel E2E tests
        run: npm run test:e2e:parallel

      - name: Upload Playwright report
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: failure()
        with:
          name: playwright-report-parallel
          path: test-results/
          retention-days: 7

  e2e-sequential:
    name: E2E Tests (Sequential)

    needs: cache

    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - uses: erlef/setup-beam@e6d7c94229049569db56a7ad5a540c051a010af9 # v1.20.4
        id: setup-beam
        with:
          version-type: strict
          version-file: .tool-versions

      - name: Setup Node.js
        uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444 # v5.0.0
        with:
          node-version-file: .tool-versions
          cache: "npm"
          cache-dependency-path: "package-lock.json"

      - name: Restore _build cache
        id: restore-build-cache
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: _build
          key: ${{ needs.cache.outputs.build-cache-key }}
          restore-keys: |
            _build-${{ runner.os }}-otp-${{ steps.setup-beam.outputs.otp-version }}-
            _build-${{ runner.os }}-

      - name: Restore rebar3 cache
        id: restore-rebar3-cache
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: ~/.cache/rebar3
          key: ${{ needs.cache.outputs.rebar-cache-key }}
          restore-keys: |
            rebar3-${{ runner.os }}-otp-${{ steps.setup-beam.outputs.otp-version }}-
            rebar3-${{ runner.os }}-

      - name: Restore Playwright browsers cache
        id: restore-playwright-cache
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: ~/.cache/ms-playwright
          key: ${{ needs.cache.outputs.playwright-cache-key }}
          restore-keys: |
            playwright-${{ runner.os }}-

      - name: Install Node.js dependencies
        run: npm ci

      - name: Install Playwright system dependencies
        if: steps.restore-playwright-cache.outputs.cache-hit == 'true'
        run: npx playwright install-deps chromium firefox

      - name: Compile Arizona for test
        run: rebar3 as test compile

      - name: Run sequential E2E tests
        run: npm run test:e2e:sequential

      - name: Upload Playwright report
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: failure()
        with:
          name: playwright-report-sequential
          path: test-results/
          retention-days: 7
