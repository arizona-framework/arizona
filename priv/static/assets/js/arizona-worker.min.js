var a=class{constructor(){this.structure={}}initialize(t){this.structure=JSON.parse(JSON.stringify(t))}applyDiff(t,e){this.structure[t]||console.warn(`[Arizona] StatefulId ${t} not found in structure`);for(let[r,i]of e){let s=this.structure[t].dynamic[r-1];s.type==="stateless"&&Array.isArray(i)?i.forEach(([h,u])=>{this.structure[t].dynamic[r-1].dynamic[h-1]=u}):s.type==="list"&&Array.isArray(i)?this.structure[t].dynamic[r-1].dynamic=i:this.structure[t].dynamic[r-1]=i}}generateStatefulHTML(t){let e=this.structure[t];return e||console.warn(`[Arizona] StatefulId ${t} not found in structure`),this.zipStaticDynamic(e.static,e.dynamic)}generateStatelessHTML(t){return this.zipStaticDynamic(t.static,t.dynamic)}generateListHTML(t){let{static:e,dynamic:r}=t;return r.reduce((i,s)=>i+this.zipStaticDynamic(e,s),"")}zipStaticDynamic(t,e){let r=[],i=Math.max(t.length,e.length);for(let s=0;s<i;s++)s<t.length&&r.push(t[s]),s<e.length&&r.push(this.normalizeDynamicElement(e[s]));return r.join("")}normalizeDynamicElement(t){return typeof t=="string"?t:t&&t.type==="stateful"?this.generateStatefulHTML(t.id):t&&t.type==="stateless"?this.generateStatelessHTML(t):t&&t.type==="list"?this.generateListHTML(t):Array.isArray(t)?this.flattenIoData(t):String(t)}flattenIoData(t){return typeof t=="string"?t:typeof t=="number"?String(t):Array.isArray(t)?t.map(e=>this.flattenIoData(e)).join(""):t&&typeof t=="object"?t.type==="stateful"?this.generateStatefulHTML(t.id):t.type==="stateless"?this.generateStatelessHTML(t):t.type==="list"?this.generateListHTML(t):String(t):String(t||"")}generateHTMLFromStructure(t){let e=[],r=Object.keys(t).map(i=>parseInt(i)).sort((i,s)=>i-s);for(let i of r){let s=t[i];typeof s=="string"?e.push(s):Array.isArray(s)?e.push(this.flattenIoData(s)):e.push(String(s))}return e.join("")}getStructure(){return JSON.parse(JSON.stringify(this.structure))}isInitialized(){return Object.keys(this.structure).length>0}getComponent(t){return this.structure[t]||null}hasComponent(t){return t in this.structure}getComponentIds(){return Object.keys(this.structure)}clear(){this.structure={}}createPatch(t){return{type:"html_patch",statefulId:t,html:this.generateStatefulHTML(t),timestamp:Date.now()}}createInitialPatch(t){return{type:"initial_render",statefulId:t,html:this.generateStatefulHTML(t),structure:this.getStructure(),timestamp:Date.now()}}};var c=a;var n=class{constructor(){this.socket=null,this.connected=!1,this.messageQueue=[],this.hierarchical=new c,self.onmessage=t=>{let{type:e,data:r}=t.data;switch(e){case"connect":this.connect(r.url);break;case"send":this.sendMessage(r);break;case"disconnect":this.disconnect();break}}}connect(t){this.connected||(this.socket=new WebSocket(t),this.socket.onopen=()=>{this.connected=!0,this.postMessage({type:"status",data:{status:"connected"}}),this.flushMessageQueue()},this.socket.onmessage=e=>{let r=JSON.parse(e.data);this.handleWebSocketMessage(r)},this.socket.onclose=()=>{this.connected=!1,this.postMessage({type:"status",data:{status:"disconnected"}})},this.socket.onerror=e=>{this.postMessage({type:"error",data:{error:e.toString()}})})}sendMessage(t){let e=JSON.stringify(t);this.connected&&this.socket.readyState===WebSocket.OPEN?this.socket.send(e):this.messageQueue.push(e)}flushMessageQueue(){for(;this.messageQueue.length>0;){let t=this.messageQueue.shift();if(this.socket.readyState===WebSocket.OPEN)this.socket.send(t);else{this.messageQueue.unshift(t);break}}}disconnect(){this.socket&&(this.socket.close(),this.socket=null),this.connected=!1,this.hierarchical.clear()}handleWebSocketMessage(t){try{switch(t.type){case"initial_render":this.handleInitialRender(t);break;case"diff":this.handleDiff(t);break;default:this.postMessage({type:"message",data:t});break}}catch(e){console.error("[Arizona Worker] Error handling message:",e),this.postMessage({type:"error",data:{error:`Message handling failed: ${e.message}`}})}}handleInitialRender(t){this.hierarchical.initialize(t.structure);let e=this.hierarchical.createInitialPatch(t.stateful_id);this.postMessage({type:"html_patch",data:{patch:e,isInitial:!0}}),console.log("[Arizona Worker] Initial render processed")}handleDiff(t){if(!this.hierarchical.isInitialized())throw new Error("Hierarchical structure not initialized");this.hierarchical.applyDiff(t.stateful_id,t.changes);let e=this.hierarchical.createPatch(t.stateful_id);this.postMessage({type:"html_patch",data:{patch:e,isInitial:!1}}),console.log("[Arizona Worker] Diff applied and patch sent")}getHierarchicalState(){return{initialized:this.hierarchical.isInitialized(),componentIds:this.hierarchical.getComponentIds(),structure:this.hierarchical.getStructure()}}postMessage(t){self.postMessage(t)}};new n;
//# sourceMappingURL=arizona-worker.min.js.map
