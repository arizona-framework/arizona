var q=11;function le(i,e){var t=e.attributes,r,n,c,d,p;if(!(e.nodeType===q||i.nodeType===q)){for(var w=t.length-1;w>=0;w--)r=t[w],n=r.name,c=r.namespaceURI,d=r.value,c?(n=r.localName||n,p=i.getAttributeNS(c,n),p!==d&&(r.prefix==="xmlns"&&(n=r.name),i.setAttributeNS(c,n,d))):(p=i.getAttribute(n),p!==d&&i.setAttribute(n,d));for(var T=i.attributes,S=T.length-1;S>=0;S--)r=T[S],n=r.name,c=r.namespaceURI,c?(n=r.localName||n,e.hasAttributeNS(c,n)||i.removeAttributeNS(c,n)):e.hasAttribute(n)||i.removeAttribute(n)}}var U,oe="http://www.w3.org/1999/xhtml",f=typeof document>"u"?void 0:document,de=!!f&&"content"in f.createElement("template"),ue=!!f&&f.createRange&&"createContextualFragment"in f.createRange();function he(i){var e=f.createElement("template");return e.innerHTML=i,e.content.childNodes[0]}function fe(i){U||(U=f.createRange(),U.selectNode(f.body));var e=U.createContextualFragment(i);return e.childNodes[0]}function pe(i){var e=f.createElement("body");return e.innerHTML=i,e.childNodes[0]}function ve(i){return i=i.trim(),de?he(i):ue?fe(i):pe(i)}function R(i,e){var t=i.nodeName,r=e.nodeName,n,c;return t===r?!0:(n=t.charCodeAt(0),c=r.charCodeAt(0),n<=90&&c>=97?t===r.toUpperCase():c<=90&&n>=97?r===t.toUpperCase():!1)}function ge(i,e){return!e||e===oe?f.createElement(i):f.createElementNS(e,i)}function ye(i,e){for(var t=i.firstChild;t;){var r=t.nextSibling;e.appendChild(t),t=r}return e}function j(i,e,t){i[t]!==e[t]&&(i[t]=e[t],i[t]?i.setAttribute(t,""):i.removeAttribute(t))}var Q={OPTION:function(i,e){var t=i.parentNode;if(t){var r=t.nodeName.toUpperCase();r==="OPTGROUP"&&(t=t.parentNode,r=t&&t.nodeName.toUpperCase()),r==="SELECT"&&!t.hasAttribute("multiple")&&(i.hasAttribute("selected")&&!e.selected&&(i.setAttribute("selected","selected"),i.removeAttribute("selected")),t.selectedIndex=-1)}j(i,e,"selected")},INPUT:function(i,e){j(i,e,"checked"),j(i,e,"disabled"),i.value!==e.value&&(i.value=e.value),e.hasAttribute("value")||i.removeAttribute("value")},TEXTAREA:function(i,e){var t=e.value;i.value!==t&&(i.value=t);var r=i.firstChild;if(r){var n=r.nodeValue;if(n==t||!t&&n==i.placeholder)return;r.nodeValue=t}},SELECT:function(i,e){if(!e.hasAttribute("multiple")){for(var t=-1,r=0,n=i.firstChild,c,d;n;)if(d=n.nodeName&&n.nodeName.toUpperCase(),d==="OPTGROUP")c=n,n=c.firstChild,n||(n=c.nextSibling,c=null);else{if(d==="OPTION"){if(n.hasAttribute("selected")){t=r;break}r++}n=n.nextSibling,!n&&c&&(n=c.nextSibling,c=null)}i.selectedIndex=t}}},k=1,Y=11,Z=3,ee=8;function A(){}function Ae(i){if(i)return i.getAttribute&&i.getAttribute("id")||i.id}function we(i){return function(t,r,n){if(n||(n={}),typeof r=="string")if(t.nodeName==="#document"||t.nodeName==="HTML"||t.nodeName==="BODY"){var c=r;r=f.createElement("html"),r.innerHTML=c}else r=ve(r);else r.nodeType===Y&&(r=r.firstElementChild);var d=n.getNodeKey||Ae,p=n.onBeforeNodeAdded||A,w=n.onNodeAdded||A,T=n.onBeforeElUpdated||A,S=n.onElUpdated||A,E=n.onBeforeNodeDiscarded||A,M=n.onNodeDiscarded||A,ne=n.onBeforeElChildrenUpdated||A,ie=n.skipFromChildren||A,G=n.addChild||function(a,s){return a.appendChild(s)},C=n.childrenOnly===!0,b=Object.create(null),N=[];function L(a){N.push(a)}function K(a,s){if(a.nodeType===k)for(var u=a.firstChild;u;){var l=void 0;s&&(l=d(u))?L(l):(M(u),u.firstChild&&K(u,s)),u=u.nextSibling}}function D(a,s,u){E(a)!==!1&&(s&&s.removeChild(a),M(a),K(a,u))}function _(a){if(a.nodeType===k||a.nodeType===Y)for(var s=a.firstChild;s;){var u=d(s);u&&(b[u]=s),_(s),s=s.nextSibling}}_(t);function I(a){w(a);for(var s=a.firstChild;s;){var u=s.nextSibling,l=d(s);if(l){var o=b[l];o&&R(s,o)?(s.parentNode.replaceChild(o,s),O(o,s)):I(s)}else I(s);s=u}}function ae(a,s,u){for(;s;){var l=s.nextSibling;(u=d(s))?L(u):D(s,a,!0),s=l}}function O(a,s,u){var l=d(s);if(l&&delete b[l],!u){var o=T(a,s);if(o===!1||(o instanceof HTMLElement&&(a=o,_(a)),i(a,s),S(a),ne(a,s)===!1))return}a.nodeName!=="TEXTAREA"?se(a,s):Q.TEXTAREA(a,s)}function se(a,s){var u=ie(a,s),l=s.firstChild,o=a.firstChild,m,v,z,x,g;e:for(;l;){for(x=l.nextSibling,m=d(l);!u&&o;){if(z=o.nextSibling,l.isSameNode&&l.isSameNode(o)){l=x,o=z;continue e}v=d(o);var P=o.nodeType,y=void 0;if(P===l.nodeType&&(P===k?(m?m!==v&&((g=b[m])?z===g?y=!1:(a.insertBefore(g,o),v?L(v):D(o,a,!0),o=g,v=d(o)):y=!1):v&&(y=!1),y=y!==!1&&R(o,l),y&&O(o,l)):(P===Z||P==ee)&&(y=!0,o.nodeValue!==l.nodeValue&&(o.nodeValue=l.nodeValue))),y){l=x,o=z;continue e}v?L(v):D(o,a,!0),o=z}if(m&&(g=b[m])&&R(g,l))u||G(a,g),O(g,l);else{var W=p(l);W!==!1&&(W&&(l=W),l.actualize&&(l=l.actualize(a.ownerDocument||f)),G(a,l),I(l))}l=x,o=z}ae(a,o,v);var J=Q[a.nodeName];J&&J(a,s)}var h=t,H=h.nodeType,X=r.nodeType;if(!C){if(H===k)X===k?R(t,r)||(M(t),h=ye(t,ge(r.nodeName,r.namespaceURI))):h=r;else if(H===Z||H===ee){if(X===H)return h.nodeValue!==r.nodeValue&&(h.nodeValue=r.nodeValue),h;h=r}}if(h===r)M(t);else{if(r.isSameNode&&r.isSameNode(h))return;if(O(h,r,C),N)for(var V=0,ce=N.length;V<ce;V++){var B=b[N[V]];B&&D(B,B.parentNode,!1)}}return!C&&h!==t&&t.parentNode&&(h.actualize&&(h=h.actualize(t.ownerDocument||f)),t.parentNode.replaceChild(h,t)),h}}var Se=we(le),te=Se;var $=class{constructor(){this.structure=new Map}initialize(e){this.structure=new Map(Object.entries(JSON.parse(JSON.stringify(e))))}applyDiff(e,t){if(t?.type==="stateful"){this.structure.set(t.id,t);return}if(!this.structure.has(e)){let r=String(e).replace(/\r|\n/g,"");console.warn(`[Arizona] StatefulId '${r}' not found in structure`)}for(let[r,n]of t)if(n&&typeof n=="object"&&n.type)this.structure.get(e).dynamic[r-1]=n;else if(Array.isArray(n)){let c=this.structure.get(e).dynamic[r-1];c&&c.type==="list"?this.structure.get(e).dynamic[r-1].dynamic=n:c&&c.type==="stateless"?n.forEach(([d,p])=>{this.structure.get(e).dynamic[r-1].dynamic[d-1]=p}):this.structure.get(e).dynamic[r-1]=n}else this.structure.get(e).dynamic[r-1]=n}generateStatefulHTML(e){let t=this.structure.get(e);if(!t){let r=String(e).replace(/\r|\n/g,"");console.warn(`[Arizona] StatefulId '${r}' not found in structure`)}return this.zipStaticDynamic(t.static,t.dynamic)}generateStatelessHTML(e){return this.zipStaticDynamic(e.static,e.dynamic)}generateListHTML(e){let{static:t,dynamic:r}=e;return r.reduce((n,c)=>n+this.zipStaticDynamic(t,c),"")}zipStaticDynamic(e,t){let r=[],n=Math.max(e.length,t.length);for(let c=0;c<n;c++)c<e.length&&r.push(e[c]),c<t.length&&r.push(this.normalizeDynamicElement(t[c]));return r.join("")}normalizeDynamicElement(e){return typeof e=="string"?e:e&&e.type==="stateful"?this.generateStatefulHTML(e.id):e&&e.type==="stateless"?this.generateStatelessHTML(e):e&&e.type==="list"?this.generateListHTML(e):Array.isArray(e)?this.flattenIoData(e):String(e)}flattenIoData(e){return typeof e=="string"?e:typeof e=="number"?String(e):Array.isArray(e)?e.map(t=>this.flattenIoData(t)).join(""):e&&typeof e=="object"?e.type==="stateful"?this.generateStatefulHTML(e.id):e.type==="stateless"?this.generateStatelessHTML(e):e.type==="list"?this.generateListHTML(e):String(e):String(e||"")}getStructure(){return JSON.parse(JSON.stringify(Object.fromEntries(this.structure)))}isInitialized(){return this.structure.size>0}getComponentIds(){return Array.from(this.structure.keys())}clear(){this.structure=new Map}createPatch(e){return{type:"html_patch",statefulId:e,html:this.generateStatefulHTML(e)}}createInitialPatch(e){return{type:"initial_render",statefulId:e,html:this.generateStatefulHTML(e)}}},re=$;var F=class{constructor(){this.worker=null,this.connected=!1,this.hierarchical=new re}connect(e={}){if(this.connected)return;let t=e.wsPath||"/live",r=e.workerPath||"/assets/js/arizona-worker.min.js";this.worker=new Worker(r,{type:"module"});let n=window.location.protocol==="https:"?"wss:":"ws:",c=window.location.host,d=window.location.pathname,p=window.location.search,w=encodeURIComponent(d),T=p?encodeURIComponent(p.substring(1)):"",S=`${n}//${c}${t}?path=${w}&qs=${T}`;this.worker.postMessage({type:"connect",data:{url:S}}),this.worker.onmessage=E=>{this.handleWorkerMessage(E.data)}}sendEvent(e,t={}){this.connected&&this.worker.postMessage({type:"send",data:{type:"event",event:e,params:t}})}sendEventTo(e,t,r={}){this.connected&&this.worker.postMessage({type:"send",data:{type:"event",stateful_id:e,event:t,params:r}})}disconnect(){this.worker&&(this.worker.terminate(),this.worker=null),this.connected=!1,this.hierarchical.clear()}handleWorkerMessage(e){let{type:t,data:r}=e;try{switch(t){case"status":this.handleStatus(r);break;case"html_patch":this.handleHtmlPatch(r);break;case"error":this.handleWorkerError(r);break;case"reload":this.handleReload(r);break;case"reply":this.handleReply(r);break;case"redirect":this.handleRedirect(r);break;default:this.handleUnknownMessage(e)}}catch(n){console.error("[Arizona] Error handling worker message:",n)}}handleStatus(e){e.status==="connected"?(this.connected=!0,console.log("[Arizona] Connected to WebSocket")):e.status==="disconnected"&&(this.connected=!1,console.log("[Arizona] Disconnected from WebSocket")),this.dispatchArizonaEvent("status",e)}handleHtmlPatch(e){let{patch:t,isInitial:r}=e;r?this.handleInitialRender(t):this.handleDiffPatch(t)}handleInitialRender(e){console.log("[Arizona] Applying initial render"),e.structure&&this.hierarchical.initialize(e.structure),this.applyHtmlPatch(e)}handleDiffPatch(e){console.log("[Arizona] Applying diff patch"),this.applyHtmlPatch(e)}applyHtmlPatch(e){let t=document.getElementById(e.statefulId);if(!t){console.warn(`[Arizona] Target element not found: ${e.statefulId}`);return}try{te(t,e.html,{onBeforeElUpdated(r,n){return!r.isEqualNode(n)}}),console.log("[Arizona] Patch applied successfully"),t.dispatchEvent(new CustomEvent("arizona:patched",{detail:{patch:e}}))}catch(r){console.error("[Arizona] Error applying HTML patch:",r)}}handleWorkerError(e){console.error("[Arizona Worker Error]:",e.error),this.dispatchArizonaEvent("error",e)}handleReload(e){console.log("[Arizona] File changed. Reloading page..."),window.location.reload()}handleReply(e){console.log("[Arizona] WebSocket reply:",e),this.dispatchArizonaEvent("reply",e)}handleRedirect(e){console.log("[Arizona] Redirecting to:",e.url),this.dispatchArizonaEvent("redirect",e),window.open(e.url,e.options?.target,e.options?.window_features)}handleUnknownMessage(e){console.warn("[Arizona] Unknown worker message:",e)}dispatchArizonaEvent(e,t){document.dispatchEvent(new CustomEvent("arizonaEvent",{detail:{type:e,data:t}}))}isConnected(){return this.connected}};export{F as default};
//# sourceMappingURL=arizona.min.js.map
